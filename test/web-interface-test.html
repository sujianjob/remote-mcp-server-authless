<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Feedback Web Interface Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .iframe-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .theme-buttons {
            margin: 10px 0;
        }
        .code {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Interactive Feedback Web Interface Test</h1>
    <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•Interactive Feedbackç³»ç»Ÿçš„Webç•Œé¢åŠŸèƒ½ã€‚</p>

    <div class="test-section">
        <h2>ğŸ“‹ 1. APIæµ‹è¯•</h2>
        <p>é¦–å…ˆæµ‹è¯•APIåŠŸèƒ½ï¼Œåˆ›å»ºä¸€ä¸ªåé¦ˆä¼šè¯ï¼š</p>
        <button class="test-button" onclick="createFeedbackSession()">åˆ›å»ºåé¦ˆä¼šè¯</button>
        <button class="test-button" onclick="testSubmitFeedback()">æµ‹è¯•æäº¤åé¦ˆ</button>
        <button class="test-button" onclick="testGetResult()">è·å–åé¦ˆç»“æœ</button>
        <div id="api-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¨ 2. Webç•Œé¢æµ‹è¯•</h2>
        <p>æµ‹è¯•ä¸åŒä¸»é¢˜å’Œè¯­è¨€çš„åé¦ˆç•Œé¢ï¼š</p>
        <div class="theme-buttons">
            <button class="test-button" onclick="loadFeedbackUI('dark', 'zh')">æš—è‰²ä¸»é¢˜ (ä¸­æ–‡)</button>
            <button class="test-button" onclick="loadFeedbackUI('light', 'zh')">æ˜äº®ä¸»é¢˜ (ä¸­æ–‡)</button>
            <button class="test-button" onclick="loadFeedbackUI('dark', 'en')">Dark Theme (English)</button>
            <button class="test-button" onclick="loadFeedbackUI('light', 'en')">Light Theme (English)</button>
        </div>
        <div class="iframe-container">
            <iframe id="feedback-iframe" src="about:blank"></iframe>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š 3. æµ‹è¯•ç»“æœ</h2>
        <div id="test-summary">
            <p>ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://127.0.0.1:8787';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ0ZXN0LXVzZXIiLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwicm9sZXMiOlsidXNlciJdLCJpYXQiOjE3NTAwNjY2OTUsImV4cCI6MTc1MDA3MDI5NX0.ps_AKBHHQHmbBrL_dXS6KsDyRZaUImTrFJzqEXrZb6A';
        
        let currentSessionId = null;
        let testResults = {
            apiCreate: false,
            apiSubmit: false,
            apiResult: false,
            webInterface: false
        };

        function showResult(containerId, message, isSuccess = true) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${isSuccess ? 'success' : 'error'}`;
            resultDiv.innerHTML = message;
            container.appendChild(resultDiv);
        }

        async function createFeedbackSession() {
            try {
                showResult('api-results', 'ğŸ”„ æ­£åœ¨åˆ›å»ºåé¦ˆä¼šè¯...', true);
                
                const response = await fetch(`${BASE_URL}/api/feedback/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'è¿™æ˜¯ä¸€ä¸ªWebç•Œé¢æµ‹è¯•ä¼šè¯ï¼Œè¯·é€‰æ‹©æ‚¨çš„åå¥½å¹¶æä¾›åé¦ˆã€‚',
                        predefinedOptions: ['ç•Œé¢ç¾è§‚', 'åŠŸèƒ½å®Œå–„', 'å“åº”è¿…é€Ÿ', 'æ˜“äºä½¿ç”¨'],
                        timeout: 1800,
                        metadata: {
                            testCase: 'web-interface-test',
                            timestamp: new Date().toISOString()
                        }
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentSessionId = result.data.sessionId;
                    testResults.apiCreate = true;
                    
                    showResult('api-results', `
                        âœ… <strong>ä¼šè¯åˆ›å»ºæˆåŠŸï¼</strong><br>
                        Session ID: <code>${result.data.sessionId}</code><br>
                        Feedback URL: <a href="${result.data.feedbackUrl}" target="_blank">${result.data.feedbackUrl}</a><br>
                        è¿‡æœŸæ—¶é—´: ${new Date(result.data.expiresAt).toLocaleString()}
                    `, true);
                    
                    // è‡ªåŠ¨åŠ è½½åé¦ˆç•Œé¢
                    loadFeedbackUI('dark', 'zh');
                } else {
                    showResult('api-results', `âŒ ä¼šè¯åˆ›å»ºå¤±è´¥: ${result.error.message}`, false);
                }
            } catch (error) {
                showResult('api-results', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
            
            updateTestSummary();
        }

        async function testSubmitFeedback() {
            if (!currentSessionId) {
                showResult('api-results', 'âŒ è¯·å…ˆåˆ›å»ºåé¦ˆä¼šè¯', false);
                return;
            }

            try {
                showResult('api-results', 'ğŸ”„ æ­£åœ¨æäº¤æµ‹è¯•åé¦ˆ...', true);
                
                const response = await fetch(`${BASE_URL}/api/feedback/${currentSessionId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selectedOptions: ['ç•Œé¢ç¾è§‚', 'åŠŸèƒ½å®Œå–„'],
                        freeText: 'è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–æµ‹è¯•æäº¤çš„åé¦ˆã€‚Webç•Œé¢çœ‹èµ·æ¥å¾ˆæ£’ï¼',
                        metadata: {
                            userAgent: navigator.userAgent,
                            timestamp: new Date().toISOString(),
                            testMode: true
                        }
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    testResults.apiSubmit = true;
                    showResult('api-results', `
                        âœ… <strong>åé¦ˆæäº¤æˆåŠŸï¼</strong><br>
                        çŠ¶æ€: ${result.data.status}<br>
                        æäº¤æ—¶é—´: ${new Date(result.data.submittedAt).toLocaleString()}
                    `, true);
                } else {
                    showResult('api-results', `âŒ åé¦ˆæäº¤å¤±è´¥: ${result.error.message}`, false);
                }
            } catch (error) {
                showResult('api-results', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
            
            updateTestSummary();
        }

        async function testGetResult() {
            if (!currentSessionId) {
                showResult('api-results', 'âŒ è¯·å…ˆåˆ›å»ºåé¦ˆä¼šè¯', false);
                return;
            }

            try {
                showResult('api-results', 'ğŸ”„ æ­£åœ¨è·å–åé¦ˆç»“æœ...', true);
                
                const response = await fetch(`${BASE_URL}/api/feedback/${currentSessionId}/result`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    testResults.apiResult = true;
                    showResult('api-results', `
                        âœ… <strong>åé¦ˆç»“æœè·å–æˆåŠŸï¼</strong><br>
                        é€‰ä¸­é€‰é¡¹: ${JSON.stringify(result.data.feedback.selectedOptions)}<br>
                        è‡ªç”±æ–‡æœ¬: ${result.data.feedback.freeText}<br>
                        ç»„åˆåé¦ˆ: <div class="code">${result.data.feedback.combinedFeedback}</div>
                    `, true);
                } else {
                    showResult('api-results', `âŒ è·å–ç»“æœå¤±è´¥: ${result.error.message}`, false);
                }
            } catch (error) {
                showResult('api-results', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
            
            updateTestSummary();
        }

        function loadFeedbackUI(theme, lang) {
            if (!currentSessionId) {
                alert('è¯·å…ˆåˆ›å»ºåé¦ˆä¼šè¯');
                return;
            }

            const iframe = document.getElementById('feedback-iframe');
            const url = `${BASE_URL}/feedback/${currentSessionId}?theme=${theme}&lang=${lang}`;
            
            iframe.src = url;
            testResults.webInterface = true;
            
            showResult('api-results', `
                ğŸ¨ <strong>åŠ è½½åé¦ˆç•Œé¢</strong><br>
                ä¸»é¢˜: ${theme}<br>
                è¯­è¨€: ${lang}<br>
                URL: <a href="${url}" target="_blank">${url}</a>
            `, true);
            
            updateTestSummary();
        }

        function updateTestSummary() {
            const summary = document.getElementById('test-summary');
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(Boolean).length;
            
            let html = `
                <h3>ğŸ“Š æµ‹è¯•è¿›åº¦: ${passed}/${total}</h3>
                <ul>
                    <li>âœ… APIåˆ›å»ºä¼šè¯: ${testResults.apiCreate ? 'é€šè¿‡' : 'å¾…æµ‹è¯•'}</li>
                    <li>âœ… APIæäº¤åé¦ˆ: ${testResults.apiSubmit ? 'é€šè¿‡' : 'å¾…æµ‹è¯•'}</li>
                    <li>âœ… APIè·å–ç»“æœ: ${testResults.apiResult ? 'é€šè¿‡' : 'å¾…æµ‹è¯•'}</li>
                    <li>âœ… Webç•Œé¢åŠ è½½: ${testResults.webInterface ? 'é€šè¿‡' : 'å¾…æµ‹è¯•'}</li>
                </ul>
            `;
            
            if (passed === total) {
                html += '<div class="result success">ğŸ‰ æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡äº†ï¼Interactive Feedbackç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚</div>';
            }
            
            summary.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            showResult('api-results', 'ğŸš€ Webç•Œé¢æµ‹è¯•å·¥å…·å·²å‡†å¤‡å°±ç»ªã€‚ç‚¹å‡»"åˆ›å»ºåé¦ˆä¼šè¯"å¼€å§‹æµ‹è¯•ã€‚', true);
        };
    </script>
</body>
</html>
